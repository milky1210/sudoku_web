# UI: 排他モード + 必要時のみスキル一覧（スマホ縦長前提）

このドキュメントは、実装済みの「書込／メモ／ビュー／スキル」排他モード設計と、スキル機能、コスト管理、開発者向けの動作確認手順（Dev Container / Docker / Playwright）をまとめたものです。

---

## 1. 要約

- モードは排他（どれか1つだけ ON）: 書込 (write), メモ (memo), ビュー (view), スキル (skill)
- 数字パッドは書込/メモ/スキル時に表示。ビュー時は非表示（誤操作防止）
- スキルはコスト制（初期コスト 5）。必要に応じて消費して便利機能を実行。
- Undo/Redo（履歴）を実装。履歴上限は簡易的に 50 ステップ。

---

## 2. 画面構成（スマホ縦長）

```
┌──────────────────────────┐
│ ヘッダー                    (タイトル / コスト表示) 
└──────────────────────────┘

┌──────────────────────────┐
│ 9x9 盤面                    (選択セル強調 / メモ表示 / スキル時ハイライト)
└──────────────────────────┘

┌──────────────────────────┐
│ モードタブ (排他): [書込][メモ][ビュー][スキル]
└──────────────────────────┘

┌──────────────────────────┐
│ 下部パネル（モード依存）
│ 書込: 数字パッド
│ メモ: 数字パッド（小表示）
│ ビュー: 非表示（最小UI）
│ スキル: 数字パッド + スキル一覧
└──────────────────────────┘
```

---

## 3. 各モード挙動

### 書込 (write)
- セルをタップして選択 → 数字パッドで数値を確定入力
- 長押しはプレビュー（未実装だが拡張余地あり）

### メモ (memo)
- セル選択後、数字ボタンで候補をトグル（小数字として表示）
- 書込の大きな数字とメモの小さい数字は明確に区別

### ビュー (view)
- 入力を無効化して確認に特化
- 数字を選んだ場合は同じ数字を盤面上でハイライト表示

### スキル (skill)
- 先に「数字」を選択してからスキルを選ぶ運用（"数字指定 → スキル発動"）
- スキル一覧はコストを表示（例: `8/9埋め【-1】`）
- 長押しでプレビュー（UI上で実装余地あり）

---

## 4. スキル一覧（実装済/簡易）

- 置けない場所ハイライト（cost: 0）
  - 選択した数字が置けないセルを赤などで表示する視覚効果
- 8/9マス自動埋め（cost: 1）
  - 各行・列・3x3 ブロックで空きが1つのみの箇所に欠けた数字を埋める
- 候補1つの自動入力（cost: 2）
  - 各空セルの候補を計算し、候補が1つのセルを自動入力
- 候補nメモ（cost: 1）
  - 選択した数字が置ける全セルにメモとして候補を付与

---

## 5. 実装ファイル（主な変更点）

- `app/src/components/SudokuGrid.vue`
  - 排他モード管理（`currentMode`）を導入
  - 数字パッドの条件表示（モードによる分岐）
  - スキル UI (`skills` 配列と `skill-panel`) の追加
  - コスト管理 (`cost`, `maxCost`) の追加
  - Undo/Redo（`history`）および履歴保存ロジック
  - `executeAuto89`, `executeAutoSingle`, `executeMemoN` などスキル実行ロジック
  - セルのクラス付与 (`getCellClass`) にモード依存のハイライト追加

- `app/tests/sudoku.spec.ts`
  - 新 UI に合わせた E2E テストを追加（モード切替、数字入力、メモ、スキルパネル確認、Undo/Redo 等）

---

## 6. 開発／実行手順

前提: Windows 環境 (PowerShell)、VS Code + Dev Containers 推奨

### A. Dev Container（推奨）
1. VS Code でプロジェクトを開く
2. コマンドパレットで: `Dev Containers: Reopen in Container`
3. コンテナが構築されたら、VS Code ターミナルから通常開発コマンドを実行

（ローカルコマンドの例: PowerShell）
```powershell
# リポジトリルート
cd C:\Users\mituk\hobby\sudoku_web
# Docker Compose を使う場合
docker compose up -d --build
# コンテナ内で開発サーバを起動する場合 (コンテナ名が `sudoku` の想定)
docker compose exec sudoku sh -c "cd /app && npm run dev -- --host 0.0.0.0 --port 5173"
# もしくはローカルで直接
cd app
npm install
npm run dev
```

ブラウザでアクセス: http://localhost:5173

### B. Playwright E2E テスト（ローカル）
```powershell
cd app
# ブラウザをインストール（初回のみ）
npx playwright install
# E2E 実行
npx playwright test
# または特定テスト
npx playwright test tests/sudoku.spec.ts
```

### C. CI（GitHub Actions）
- `.github/workflows/ci.yml` にて Docker Buildx を使った image ビルド -> テスト実行 を行っています。
- 修正例: `file: ./docker/Dockerfile.ci` のようにパスをCIワークフローに合わせています。

---

## 7. テスト追加ポイント / 注意点

- E2E は UI の再描画・非同期処理に敏感です。選択後に少し待つ (`page.waitForTimeout(100)` 等) で安定化させています。
- テストでは "空セルを見つけて選択 → 数字操作 → 検証" の流れを踏んでいます。
- 将来的には Playwright の `waitFor` / `expect.toBeVisible()` を多用してさらに安定化可能。

---

## 8. 今後の改善案（優先順）

1. スキルの可視プレビュー（長押しで実行結果をプレビュー）
2. パフォーマンス最適化（大量の再描画を抑制）
3. 追加のE2Eテスト（スキルの副作用、複数ステップのUndo/Redo）
4. アクセシビリティ改善（ARIAラベル、キーボード操作のサポート）
5. 高密度UI（片手操作最適化）とアニメーションの微調整

---

## 9. 補足 / 参照
- 実装済みファイル:
  - `app/src/components/SudokuGrid.vue`
  - `app/tests/sudoku.spec.ts`
- もし README にリンク追加希望があれば教えてください。README へ短いリンクを追加します。

---

作業した実装やテストで分からない箇所があれば指示ください。実装をさらにブラッシュアップして、UIモーションやプレビュー機能、追加テストまで進めます。